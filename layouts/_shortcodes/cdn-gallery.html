{{/*
  CDN Gallery Shortcode
  
  Usage: {{< cdn-gallery type="events" >}}
  
  Displays a gallery of images from the CDN for the specified type.
  Only shows if params.cdn.galleries.<type> is set to a number > 0.
  
  CDN URL resolution:
  - If BASEURL contains localhost or 127.0.0.1: use params.cdn.localhost
  - If params.cdn.<baseurl> exists: use that value
  - Otherwise: use params.cdn.default
*/}}

{{- $galleryId := .Get "id" -}}
{{- if not $galleryId -}}
  {{- errorf "cdn-gallery shortcode requires 'id' parameter" -}}
{{- end -}}

{{- $galleryData := index .Page.Params.cdn.galleries $galleryId -}}
{{- $imageCount := $galleryData.count -}}
{{- if not $imageCount -}}
  {{- /* No images for this gallery, don't render anything */ -}}
{{- else -}}
  {{- /* Get CDN base URL */ -}}
  {{- $baseURL := .Site.BaseURL -}}
  {{- $cdnURL := "" -}}
  
  {{- /* Check if we're running locally (development server) */ -}}
  {{- $isLocalDev := or (in $baseURL "localhost") (in $baseURL "127.0.0.1") (in $baseURL ":1313") -}}
  
  {{- if $isLocalDev -}}
    {{- $cdnURL = .Site.Params.cdn.localhost -}}
  {{- else -}}
    {{- $baseURLHost := replaceRE "^https?://([^/]+).*" "$1" $baseURL -}}
    {{- $cdnURL = index .Site.Params.cdn $baseURLHost -}}
    {{- if not $cdnURL -}}
      {{- $cdnURL = .Site.Params.cdn.default -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Find the gallery configuration by ID across all Hugo types */ -}}
  {{- $config := "" -}}
  {{- range $hugoType, $galleries := .Site.Params.cdn.galleries -}}
    {{- if index $galleries $galleryId -}}
      {{- $config = index $galleries $galleryId -}}
      {{- break -}}
    {{- end -}}
  {{- end -}}
  
  {{- if not $config -}}
    {{- errorf "No cdn.galleries configuration found for id: %s" $galleryId -}}
  {{- end -}}
  {{- $prefix := $config.prefix | default (printf "%s-" $galleryId) -}}
  {{- $extension := default "jpg" $config.extension -}}
  {{- $name := $config.name -}}
  {{- $padding := default 3 $config.padding -}}
  
  {{- /* Get thumbnail configuration */ -}}
  {{- $thumbSize := $config.thumb_size -}}
  {{- $thumbSuffix := printf "-%d" $thumbSize -}}
  {{- $thumbExt := "webp" -}}
  
  {{- /* Map gallery ID to CDN directory name */ -}}
  {{- $cdnDirName := "" -}}
  {{- if eq $galleryId "poster" -}}
    {{- $cdnDirName = "posters" -}}
  {{- else if eq $galleryId "still" -}}
    {{- $cdnDirName = "film-stills" -}}
  {{- else if eq $galleryId "bts" -}}
    {{- $cdnDirName = "bts" -}}
  {{- else if eq $galleryId "group" -}}
    {{- $cdnDirName = "group-photos" -}}
  {{- else if eq $galleryId "event" -}}
    {{- $cdnDirName = "events" -}}
  {{- else -}}
    {{- $cdnDirName = $galleryId -}}
  {{- end -}}
  
  {{- /* Generate gallery HTML */ -}}
  <div class="cdn-gallery" data-type="{{ $galleryId }}" style="--thumb-size: {{ $thumbSize }}px;">
    <h3>{{ $name }}</h3>
    <div class="gallery-grid">
      {{- range $i := (seq 1 $imageCount) -}}
        {{- $paddedNum := printf "%0*d" $padding $i -}}
        {{- $imageName := printf "%s%s.%s" $prefix $paddedNum $extension -}}
        {{- $thumbName := printf "%s%s%s.%s" $prefix $paddedNum $thumbSuffix $thumbExt -}}
        {{- $contentPath := printf "%s/%s" $cdnDirName .Page.Slug -}}
        {{- $imageURL := printf "%s/%s/%s" $cdnURL $contentPath $imageName -}}
        {{- $thumbURL := printf "%s/%s/thumbs/%s" $cdnURL $contentPath $thumbName -}}
        
        <div class="gallery-item">
          <a href="{{ $imageURL }}" data-lightbox="{{ $galleryId }}-gallery" data-title="{{ $name }} {{ $i }}">
            <img src="{{ $thumbURL }}" 
                 alt="{{ $name }} {{ $i }}" 
                 loading="lazy">
          </a>
        </div>
      {{- end -}}
    </div>
  </div>
{{- end -}}
