{{/*
  CDN Gallery Partial
  
  Displays a specific gallery of images from the CDN.
  Takes a gallery ID parameter to show a specific gallery type.
  
  CDN URL resolution:
  - If BASEURL contains localhost or 127.0.0.1: use params.cdn.localhost
  - If params.cdn.<baseurl> exists: use that value
  - Otherwise: use params.cdn.default
*/}}

{{- $galleryId := .galleryId -}}
{{- if not $galleryId -}}
  {{- errorf "cdn-gallery partial requires galleryId parameter" -}}
{{- end -}}

{{- if .Params.galleries -}}
  {{- $galleryData := index .Params.galleries $galleryId -}}
  {{- if $galleryData -}}
    {{- $imageCount := $galleryData.count -}}
    {{- if and $imageCount (gt $imageCount 0) -}}
      {{- /* Get CDN base URL */ -}}
      {{- $baseURL := .Site.BaseURL -}}
      {{- $cdnURL := "" -}}
      
      {{- /* Check if we're running locally using environment variable or baseURL */ -}}
      {{- $envBaseURL := os.Getenv "HUGO_BASEURL" -}}
      {{- $forceProductionCDN := os.Getenv "HUGO_FORCE_PRODUCTION_CDN" -}}
      {{- $isLocalDev := and (not $forceProductionCDN) (or (in $baseURL "localhost") (in $baseURL "127.0.0.1") (in $baseURL ":1313") (and $envBaseURL (in $envBaseURL "localhost"))) -}}
      
      {{- if $isLocalDev -}}
        {{- $cdnURL = "/cdn" -}}
      {{- else -}}
        {{- $baseURLHost := replaceRE "^https?://([^/]+).*" "$1" $baseURL -}}
        {{- $cdnURL = index .Site.Params.cdn $baseURLHost -}}
        {{- if not $cdnURL -}}
          {{- $cdnURL = .Site.Params.cdn.default -}}
        {{- end -}}
      {{- end -}}
      
      {{- /* Capture the page context */ -}}
      {{- $pageSlug := path.Base .RelPermalink -}}
      {{- $pageSection := .Section -}}
      
      {{- /* Find the gallery configuration by ID across all Hugo types */ -}}
      {{- $config := "" -}}
      {{- range $hugoType, $galleries := $.Site.Params.galleries -}}
        {{- if index $galleries $galleryId -}}
          {{- $config = index $galleries $galleryId -}}
          {{- break -}}
        {{- end -}}
      {{- end -}}
      
      {{- if $config -}}
        {{- $prefix := $config.prefix | default (printf "%s-" $galleryId) -}}
        {{- $extension := default "jpg" $config.extension -}}
        {{- $name := $config.name -}}
        {{- $padding := default 3 $config.padding -}}
        
        {{- /* Check for event-specific photographer credit, fall back to global config */ -}}
        {{- $credit := "" -}}
        {{- if .Params.galleries -}}
          {{- $eventGallery := index .Params.galleries $galleryId -}}
          {{- if and $eventGallery $eventGallery.credit -}}
            {{- $credit = $eventGallery -}}
          {{- end -}}
        {{- end -}}
        {{- if not $credit -}}
          {{- $credit = $config -}}
        {{- end -}}
        
        {{- /* Get thumbnail configuration */ -}}
        {{- $thumbSize := $config.thumb_size -}}
        {{- $thumbSuffix := printf "-%d" $thumbSize -}}
        {{- $thumbExt := "webp" -}}
        
        {{- /* Get content type from captured page section */ -}}
        {{- $contentType := $pageSection -}}
        
        {{- /* Generate gallery HTML */ -}}
        <div class="cdn-gallery" data-type="{{ $galleryId }}" style="--thumb-size: {{ $thumbSize }}px;" data-total-images="{{ $imageCount }}">
          <h2>{{ $name }}</h2>
          <div class="gallery-grid" id="gallery-grid-{{ $galleryId }}">
            {{- /* Show first 24 images initially */ -}}
            {{- $initialCount := 24 -}}
            {{- if lt $imageCount $initialCount -}}
              {{- $initialCount = $imageCount -}}
            {{- end -}}
            {{- range $i := (seq 1 $initialCount) -}}
              {{- $paddedNum := printf "%0*d" $padding $i -}}
              {{- $imageName := printf "%s%s.%s" $prefix $paddedNum $extension -}}
              {{- $thumbName := printf "%s%s%s.%s" $prefix $paddedNum $thumbSuffix $thumbExt -}}
              {{- $contentPath := printf "%s/%s" $contentType $pageSlug -}}
              {{- $imageURL := printf "%s/%s/%s" $cdnURL $contentPath $imageName -}}
              {{- $thumbURL := printf "%s/%s/thumbs/%s" $cdnURL $contentPath $thumbName -}}
              
              <div class="gallery-item">
                <a href="{{ $imageURL }}" 
                   class="gallery-link" 
                   data-gallery="{{ $galleryId }}-gallery" 
                   data-index="{{ $i }}"
                   data-title="{{ $name }} {{ $i }}">
                  <img src="{{ $thumbURL }}" 
                       alt="{{ $name }} {{ $i }}" 
                       loading="lazy">
                </a>
              </div>
            {{- end -}}
          </div>
          
          {{- /* Load More Button - only show if there are more images */ -}}
          {{- if gt $imageCount $initialCount -}}
            <div class="gallery-load-more-container">
              <button class="gallery-load-more-btn" 
                      data-gallery="{{ $galleryId }}" 
                      data-loaded="{{ $initialCount }}" 
                      data-total="{{ $imageCount }}"
                      data-cdn-url="{{ $cdnURL }}"
                      data-content-path="{{ $contentType }}/{{ $pageSlug }}"
                      data-prefix="{{ $prefix }}"
                      data-extension="{{ $extension }}"
                      data-thumb-suffix="{{ $thumbSuffix }}"
                      data-thumb-ext="{{ $thumbExt }}"
                      data-padding="{{ $padding }}"
                      data-name="{{ $name }}">
                <span class="load-more-text">
                  + Load More Photos 
                  <span class="load-more-count">({{ sub $imageCount $initialCount }} more)</span>
                </span>
                <span class="load-more-loading" style="display: none;">
                  <svg class="loading-spinner" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z">
                      <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" from="0 12 12" to="360 12 12"/>
                    </path>
                  </svg>
                  Loading...
                </span>
              </button>
            </div>
          {{- end -}}
          
          {{- /* Photographer credit below load more button */ -}}
          {{- if $credit.credit -}}
            <div class="photographer-credit-top">
              {{- /* Alternate photo location */ -}}
              {{- if $credit.alternate -}}
                <p>
                  {{- if $credit.alternate_url -}}
                    <a href="{{ $credit.alternate_url }}"><strong>{{ $credit.alternate }}</strong></a>
                  {{- else -}}
                    <strong>{{ $credit.alternate }}</strong>
                  {{- end -}}
                </p>
              {{- end -}}
              <p>
                {{- if $credit.credit_url -}}
                  <a href="{{ $credit.credit_url }}" target="_blank" rel="noopener">{{ $credit.credit }}</a>
                {{- else -}}
                  {{ $credit.credit }}
                {{- end -}}
              </p>
            </div>
          {{- end -}}
        </div>
        
        {{- /* Lightbox HTML */ -}}
        <div class="lightbox" id="lightbox-{{ $galleryId }}-gallery">
          <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox('{{ $galleryId }}-gallery')">&times;</button>
            <button class="lightbox-nav lightbox-prev" onclick="previousImage('{{ $galleryId }}-gallery')">
              <span class="nav-arrow">‹</span>
              <img class="nav-thumbnail nav-thumb-prev" src="" alt="" style="display: none;">
            </button>
            <img class="lightbox-image" src="" alt="">
            <button class="lightbox-nav lightbox-next" onclick="nextImage('{{ $galleryId }}-gallery')">
              <span class="nav-arrow">›</span>
              <img class="nav-thumbnail nav-thumb-next" src="" alt="" style="display: none;">
            </button>
            <button class="lightbox-download" onclick="downloadImage('{{ $galleryId }}-gallery')" title="Download image">
              <svg class="download-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
            </button>
            <div class="lightbox-counter">
              <span class="lightbox-current">1</span> / <span class="lightbox-total">{{ $imageCount }}</span>
            </div>
            {{- /* Photographer credit at bottom of lightbox */ -}}
            {{- if $credit.credit -}}
              <div class="photographer-credit-lightbox">
                <p>
                  {{- if $credit.credit_url -}}
                    <a href="{{ $credit.credit_url }}" target="_blank" rel="noopener">{{ $credit.credit }}</a>
                  {{- else -}}
                    {{ $credit.credit }}
                  {{- end -}}
                </p>
              </div>
            {{- end -}}
          </div>
        </div>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}